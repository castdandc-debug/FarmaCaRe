{% extends "base.html" %}
{% block title %}Editar Producto{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Editar Producto</h2>
    <form method="POST">
        <div class="mb-3">
            <label>Código de Barras</label>
            <div class="input-group">
                <input type="text" name="codigo_barras" id="codigo_barras" class="form-control" required value="{{ producto.codigo_barras }}">
                <button type="button" class="btn btn-outline-secondary" id="btn-escanear-codigo">Escanear</button>
            </div>
            <div id="reader" style="width:300px; display:none; margin-top:10px;"></div>
        </div>
        <div class="mb-3">
            <label>Nombre Comercial</label>
            <input type="text" name="nombre_comercial" class="form-control" required value="{{ producto.nombre_comercial }}">
        </div>
        <div class="mb-3">
            <label id="label-nombre-generico">{{ 'Nombre Genérico' if tipo == 'medicamento' else 'Nombre Común' }}</label>
            <input type="text" name="nombre_generico" class="form-control" required value="{{ producto.nombre_generico if tipo == 'medicamento' else producto.nombre_comun }}">
        </div>
        {% if tipo == "medicamento" %}
        <div class="mb-3">
            <label>Grupo / Tipo de Medicamento</label>
            <select name="grupo" class="form-control">
                <option value="Medicamento I" {% if producto.grupo == 'Medicamento I' %}selected{% endif %}>Medicamento I</option>
                <option value="Medicamento II" {% if producto.grupo == 'Medicamento II' %}selected{% endif %}>Medicamento II</option>
                <option value="Medicamento III" {% if producto.grupo == 'Medicamento III' %}selected{% endif %}>Medicamento III</option>
                <option value="Medicamento IV" {% if producto.grupo == 'Medicamento IV' %}selected{% endif %}>Medicamento IV</option>
                <option value="Medicamento antibiótico" {% if producto.grupo == 'Medicamento antibiótico' %}selected{% endif %}>Medicamento antibiótico</option>
                <option value="Medicamento V" {% if producto.grupo == 'Medicamento V' %}selected{% endif %}>Medicamento V</option>
                <option value="Medicamento VI" {% if producto.grupo == 'Medicamento VI' %}selected{% endif %}>Medicamento VI</option>
            </select>
        </div>
        {% endif %}
        <div class="mb-3">
            <label>Laboratorio</label>
            <input type="text" name="laboratorio" class="form-control" value="{{ producto.laboratorio }}">
        </div>
        <div class="mb-3">
            <label>Presentación</label>
            <input type="text" name="presentacion" class="form-control" required value="{{ producto.presentacion }}">
        </div>
        <div class="mb-3">
            <label>IVA (%)</label>
            <input type="number" name="iva" id="iva" step="0.01" class="form-control" required value="{{ producto.iva }}">
        </div>
        <div class="mb-3">
            <label>Descuento (%)</label>
            <input type="number" name="descuento" id="descuento" step="0.01" class="form-control" required value="{{ producto.descuento }}">
        </div>
        <div class="mb-3">
            <label>Precio Público (base)</label>
            <input type="number" id="precio_publico" step="0.01" class="form-control" value="{% if tipo=='medicamento' %}{{ (producto.precio_venta / (1 + producto.iva/100)) / (1 - producto.descuento/100) | round(2) }}{% else %}{{ (producto.precio_venta / (1 + producto.iva/100)) / (1 - producto.descuento/100) | round(2) }}{% endif %}" required>
        </div>
        <div class="mb-3">
            <label>Precio de Venta (con IVA y descuento)</label>
            <input type="number" name="precio_venta" id="precio_venta" step="0.01" class="form-control" required value="{{ producto.precio_venta }}" readonly>
        </div>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        <a href="{{ url_for('productos.lista') }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
function calcPrecioVenta() {
    const precioBase = parseFloat(document.getElementById("precio_publico").value) || 0;
    const descuento = parseFloat(document.getElementById("descuento").value) || 0;
    const iva = parseFloat(document.getElementById("iva").value) || 0;
    // Aplica descuento primero
    let precioConDescuento = precioBase * (1 - descuento/100);
    // Luego aplica IVA sobre el resultado
    let precioFinal = precioConDescuento * (1 + iva/100);
    document.getElementById("precio_venta").value = precioFinal.toFixed(2);
}

window.onload = function() {
    calcPrecioVenta();
};

// Escáner de código de barras
document.getElementById('btn-escanear-codigo').addEventListener('click', function() {
    var reader = document.getElementById('reader');
    reader.style.display = "block";
    let html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText, decodedResult) => {
            document.getElementById('codigo_barras').value = decodedText;
            html5QrcodeScanner.stop().then(_ => {
                reader.style.display = "none";
            }).catch(_ => {
                reader.style.display = "none";
            });
        }
    ).catch(err => {
        alert("No se pudo acceder a la cámara: " + err);
    });
});

document.getElementById("precio_publico").addEventListener("input", calcPrecioVenta);
document.getElementById("descuento").addEventListener("input", calcPrecioVenta);
document.getElementById("iva").addEventListener("input", calcPrecioVenta);
</script>
{% endblock %}
