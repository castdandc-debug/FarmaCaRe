{% extends "base.html" %}
{% block title %}Listado de Ventas{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- CORREGIDO: Cambiado 'admin.dashboard' por 'main.dashboard' (o el endpoint real de tu dashboard) -->
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-success mb-3">&larr; Volver al Administrador</a>
    <h2>Ventas realizadas</h2>
    <div class="mb-3">
        <a href="{{ url_for('ventas.nueva') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nueva Venta
        </a>
    </div>
    <!-- Filtros (fecha, cliente, usuario) -->
    <form method="GET" class="row g-3 mb-3">
        <div class="col-md-3">
            <label for="fecha" class="form-label">Fecha:</label>
            <input type="date" class="form-control" name="fecha" id="fecha" value="{{ request.args.get('fecha', '') }}">
        </div>
        <div class="col-md-3">
            <label for="cliente_id" class="form-label">Cliente:</label>
            <select class="form-select" name="cliente_id" id="cliente_id">
                <option value="">Todos</option>
                {% for c in clientes %}
                    <option value="{{ c.id }}" {% if request.args.get('cliente_id')==c.id|string %}selected{% endif %}>{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="usuario_id" class="form-label">Vendedor:</label>
            <select class="form-select" name="usuario_id" id="usuario_id">
                <option value="">Todos</option>
                {% for u in usuarios %}
                    <option value="{{ u.id }}" {% if request.args.get('usuario_id')==u.id|string %}selected{% endif %}>{{ u.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-info me-2"><i class="bi bi-search"></i> Filtrar</button>
            <a href="{{ url_for('ventas.listado') }}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Limpiar</a>
        </div>
    </form>

    <!-- Tabla de ventas -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th>Folio</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Total</th>
                    <th>Método de pago</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
            {% for venta in ventas %}
                <tr>
                    <td>{{ venta.folio }}</td>
                    <td>{{ venta.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        {% if venta.cliente %}
                            {{ venta.cliente.nombre }}
                        {% else %}
                            Público en general
                        {% endif %}
                    </td>
                    <td>{{ venta.usuario.nombre }}</td>
                    <td>$ {{ '%.2f'|format(venta.total) }}</td>
                    <td>{{ venta.metodo_pago|capitalize }}</td>
                    <td>
                        <a href="{{ url_for('ventas.ticket', venta_id=venta.id) }}" class="btn btn-sm btn-outline-info" title="Ver ticket">
                            <i class="bi bi-receipt"></i>
                        </a>
                        <a href="{{ url_for('ventas.editar', venta_id=venta.id) }}" class="btn btn-sm btn-outline-warning" title="Editar venta">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <form action="{{ url_for('ventas.eliminar', venta_id=venta.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Seguro que deseas eliminar la venta?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar venta">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        <!-- Botón de facturar venta -->
                        <a href="{{ url_for('ventas.facturar', venta_id=venta.id) }}" class="btn btn-outline-success btn-sm" title="Facturar esta venta">
                            <i class="bi bi-file-earmark-text"></i>
                        </a>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="7" class="text-center">No hay ventas registradas.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Bootstrap icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}
