{% extends "base.html" %}

{% block title %}Nueva Venta{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Nueva Venta</h2>
    <form id="ventaForm" method="POST" autocomplete="off">
        <!-- Cliente opcional -->
        <div class="mb-3">
            <label for="cliente_id" class="form-label">Cliente (opcional):</label>
            <select class="form-select" name="cliente_id" id="cliente_id">
                <option value="">-- Público en general --</option>
                {% for c in clientes %}
                    <option value="{{ c.id }}">{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Buscador de productos y botón NO HAY -->
        <div class="mb-3 row align-items-end">
            <div class="col-md-6">
                <label for="buscador_producto" class="form-label">Buscar producto:</label>
                <input type="text" class="form-control" id="buscador_producto" placeholder="Código de barras, nombre, genérico o presentación" autocomplete="off">
                <input type="hidden" id="producto_id">
                <div id="no-result" class="text-danger small" style="display:none;">Producto no encontrado. ¿Deseas reportarlo?</div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-secondary" id="btn-escanear">
                    <i class="bi bi-upc-scan"></i> Escanear
                </button>
            </div>
            <div class="col-md-2">
                <label for="cantidad_producto" class="form-label">Cantidad:</label>
                <input type="number" min="1" class="form-control" id="cantidad_producto" value="1">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-warning" id="btn-nohay" style="width:100%;">NO HAY</button>
            </div>
        </div>

        <!-- Contenedor del escáner -->
        <div id="scanner-container" style="display:none;">
            <div id="reader" width="300px"></div>
            <button type="button" class="btn btn-secondary mt-2" id="btn-cerrar-escaner">Cerrar escáner</button>
        </div>

        <!-- Tabla de productos agregados -->
        <table class="table table-bordered mt-3" id="tabla_venta">
            <thead>
                <tr>
                    <th>Código de barras</th>
                    <th>Producto</th>
                    <th>Presentación</th>
                    <th>Precio</th>
                    <th>IVA (%)</th>
                    <th>Descuento (%)</th>
                    <th>Cantidad</th>
                    <th>Importe</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Se agregan productos aquí -->
            </tbody>
        </table>

        <!-- Totales -->
        <div class="row g-2 mt-2">
            <div class="col-sm-3">
                <div class="form-control-plaintext">Total artículos: <span id="total_articulos">0</span></div>
            </div>
            <div class="col-sm-3">
                <div class="form-control-plaintext">Subtotal: $<span id="subtotal">0.00</span></div>
            </div>
            <div class="col-sm-2">
                <div class="form-control-plaintext">IVA: $<span id="total_iva">0.00</span></div>
            </div>
            <div class="col-sm-2">
                <div class="form-control-plaintext">Descuento: $<span id="total_descuento">0.00</span></div>
            </div>
            <div class="col-sm-2">
                <div class="form-control-plaintext fw-bold">Total: $<span id="importe_total">0.00</span></div>
            </div>
        </div>
        <button type="button" class="btn btn-success mt-3" id="btn-confirmar-venta">Registrar Venta</button>
    </form>

    <!-- Modal Confirmar Venta -->
    <div class="modal" tabindex="-1" id="modalConfirmarVenta">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formConfirmarVenta">
            <div class="modal-header">
              <h5 class="modal-title">Confirmar venta</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div>
                <strong>Total a pagar:</strong> <span id="modal_total"></span>
              </div>
              <div class="mt-2">
                <label for="metodo_pago" class="form-label">Método de pago:</label>
                <select class="form-select" id="metodo_pago" name="metodo_pago" required>
                  <option value="efectivo">Efectivo</option>
                  <option value="tarjeta">Tarjeta</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Confirmar y registrar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal NO HAY -->
    <div class="modal" tabindex="-1" id="modalNoHay">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formNoHay" method="POST" action="">
            <div class="modal-header">
              <h5 class="modal-title">Registrar producto NO HAY</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label for="nombre_nohay" class="form-label">Nombre producto:</label>
                <input type="text" class="form-control" id="nombre_nohay" name="nombre_nohay" required>
              </div>
              <div class="mb-2">
                <label for="tipo_nohay" class="form-label">Tipo (opcional):</label>
                <input type="text" class="form-control" id="tipo_nohay" name="tipo_nohay">
              </div>
              <div class="alert alert-info small">
                Este registro será revisado por administración para <b>crear el producto</b> o <b>reajustar el punto de reorden</b> desde el módulo de reportes/inventarios.
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-warning">Registrar como NO HAY</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>

<!-- Bootstrap, jQuery, Bootstrap Icons, jQuery UI, html5-qrcode -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let productos_agregados = {};
let ultimaBusqueda = "";
$(function() {
    // Autocomplete productos
    $("#buscador_producto").autocomplete({
        minLength: 2,
        source: function(request, response) {
            ultimaBusqueda = request.term;
            $.getJSON("{{ url_for('ventas.autocompletar_producto') }}", { q: request.term }, function(data) {
                if (data && data.length > 0) {
                    $("#no-result").hide();
                    response(data);
                } else {
                    $("#no-result").show();
                    response([]);
                }
            });
        },
        select: function(event, ui) {
            $("#producto_id").val(ui.item.id);
            agregarProducto(ui.item);
            $("#buscador_producto").val("");
            $("#cantidad_producto").val("1");
            $("#no-result").hide();
            return false;
        }
    }).autocomplete("instance")._renderItem = function(ul, item) {
        return $("<li>")
            .append(`<div><strong>${item.nombre_comercial}</strong> (${item.nombre_generico}) <br>
                    <small>${item.presentacion} | Código: ${item.codigo_barras}</small></div>`)
            .appendTo(ul);
    };

    // Si no hay resultado, mostrar opción NO HAY
    $("#buscador_producto").on("keydown", function(e) {
        if (e.key === "Enter" && $("#no-result").is(":visible")) {
            e.preventDefault();
            $("#btn-nohay").trigger("click");
        }
    });

    // Escanear código
    let html5QrCode;
    $("#btn-escanear").on("click", function() {
        $("#scanner-container").show();
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            code => {
                $("#buscador_producto").val(code);
                html5QrCode.stop();
                $("#scanner-container").hide();
                // Buscar producto por código
                $.getJSON("{{ url_for('ventas.autocompletar_producto') }}", { q: code }, function(data) {
                    if (data.length > 0) {
                        agregarProducto(data[0]);
                        $("#buscador_producto").val("");
                        $("#cantidad_producto").val("1");
                        $("#no-result").hide();
                    } else {
                        $("#no-result").show();
                    }
                });
            }
        );
        $("#btn-cerrar-escaner").off("click").on("click", function() {
            html5QrCode.stop();
            $("#scanner-container").hide();
        });
    });

    // NO HAY modal
    $("#btn-nohay").on("click", function(e) {
        e.preventDefault();
        let nom = $("#buscador_producto").val() || ultimaBusqueda || "";
        $("#nombre_nohay").val(nom);
        $("#modalNoHay").modal("show");
    });
    $("#formNoHay").on("submit", function(e) {
        e.preventDefault();
        $.post("{{ url_for('ventas.nueva') }}", {
            nombre_nohay: $("#nombre_nohay").val(),
            tipo_nohay: $("#tipo_nohay").val(),
            no_hay_submit: true
        }, function() {
            $("#modalNoHay").modal('hide');
            $("#buscador_producto").val("");
            $("#no-result").hide();
            alert("Producto registrado como NO HAY. El área de administración lo revisará.");
        });
    });

    // Agregar producto por enter en campo cantidad (si hay producto seleccionado)
    $("#cantidad_producto").on("keypress", function(e) {
        if (e.which === 13) {
            let prod_id = $("#producto_id").val();
            if (prod_id) {
                // Buscar de nuevo para obtener todos los datos
                $.getJSON("{{ url_for('ventas.autocompletar_producto') }}", { q: prod_id }, function(data) {
                    if (data.length > 0) {
                        agregarProducto(data[0]);
                        $("#producto_id").val("");
                        $("#buscador_producto").val("");
                        $("#cantidad_producto").val("1");
                    }
                });
            }
            e.preventDefault();
        }
    });

    // Botón confirmar venta muestra modal
    $("#btn-confirmar-venta").on("click", function(e) {
        e.preventDefault();
        if (Object.keys(productos_agregados).length === 0) {
            alert("Agrega al menos un producto a la venta.");
            return;
        }
        $("#modal_total").text("$" + $("#importe_total").text());
        $("#modalConfirmarVenta").modal("show");
    });

    // Registrar venta al confirmar modal
    $("#formConfirmarVenta").on("submit", function(e) {
        e.preventDefault();
        // Añade campo método de pago al formulario original
        if ($("#ventaForm input[name='metodo_pago']").length === 0) {
            $("<input>")
                .attr("type", "hidden")
                .attr("name", "metodo_pago")
                .val($("#metodo_pago").val())
                .appendTo("#ventaForm");
        } else {
            $("#ventaForm input[name='metodo_pago']").val($("#metodo_pago").val());
        }
        $("#modalConfirmarVenta").modal("hide");
        $("#ventaForm").off("submit").submit(); // Forzar submit real
    });
});

// Función para agregar producto a la tabla
function agregarProducto(item) {
    if (productos_agregados[item.id]) {
        alert("El producto ya fue agregado.");
        return;
    }
    let cantidad = parseInt($("#cantidad_producto").val()) || 1;
    // Ya no hay validación de stock
    let importe = item.precio_venta * cantidad;
    let iva = item.iva;
    let descuento = item.descuento;
    let fila = `<tr data-id="${item.id}">
        <td>${item.codigo_barras}<input type="hidden" name="med_${item.id}" value="${cantidad}"></td>
        <td>${item.nombre_comercial} <br><small>${item.nombre_generico}</small></td>
        <td>${item.presentacion}</td>
        <td>$${item.precio_sin_iva.toFixed(2)}</td>
        <td>${iva}%</td>
        <td>${descuento}%</td>
        <td><input type="number" min="1" class="form-control cantidad" value="${cantidad}"></td>
        <td class="importe">$${importe.toFixed(2)}</td>
        <td><button type="button" class="btn btn-link btn-sm text-danger quitar"><i class="bi bi-trash"></i></button></td>
    </tr>`;
    $("#tabla_venta tbody").append(fila);
    productos_agregados[item.id] = item;
    productos_agregados[item.id].cantidad = cantidad;
    actualizarTotales();
}
// Eliminar producto
$("#tabla_venta").on("click", ".quitar", function() {
    let row = $(this).closest("tr");
    let id = row.data("id");
    row.remove();
    delete productos_agregados[id];
    actualizarTotales();
});
// Cambiar cantidad
$("#tabla_venta").on("change", ".cantidad", function() {
    let row = $(this).closest("tr");
    let id = row.data("id");
    let cantidad = parseInt($(this).val());
    // Ya no hay validación de stock
    productos_agregados[id].cantidad = cantidad;
    let importe = productos_agregados[id].precio_venta * cantidad;
    row.find(".importe").text("$" + importe.toFixed(2));
    row.find(`input[name="med_${id}"]`).val(cantidad);
    actualizarTotales();
});
// Actualizar totales
function actualizarTotales() {
    let total_articulos = 0, subtotal = 0, total_iva = 0, total_descuento = 0, importe_total = 0;
    $("#tabla_venta tbody tr").each(function() {
        let id = $(this).data("id");
        let item = productos_agregados[id];
        let cantidad = parseInt($(this).find(".cantidad").val()) || 1;
        let precio = item.precio_sin_iva;
        let iva = (precio * cantidad) * (item.iva/100);
        let desc = (precio * cantidad) * (item.descuento/100);
        let importe = (precio * cantidad) + iva - desc;
        total_articulos += cantidad;
        subtotal += precio * cantidad;
        total_iva += iva;
        total_descuento += desc;
        importe_total += importe;
    });
    $("#total_articulos").text(total_articulos);
    $("#subtotal").text(subtotal.toFixed(2));
    $("#total_iva").text(total_iva.toFixed(2));
    $("#total_descuento").text(total_descuento.toFixed(2));
    $("#importe_total").text(importe_total.toFixed(2));
}

</script>
{% endblock %}
